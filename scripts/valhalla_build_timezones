#!/bin/sh

error_exit() {
  echo "Error: $1" 1>&2
}

if [ ! -f ./timezones-with-oceans.shapefile.zip ]; then
  echo "Downloading timezone polygon file..." 1>&2
  url="https://github.com/evansiroky/timezone-boundary-builder/releases/download/2024a/timezones-with-oceans.shapefile.zip"
  curl -L -s -o ./timezones-with-oceans.shapefile.zip ${url} || error_exit "curl failed for ${url}"
else
  echo "Timezone polygon file already exists. Skipping download." 1>&2
fi

unzip ./timezones-with-oceans.shapefile.zip 1>&2 || error_exit "unzip failed"

tz_file=$(mktemp)
spatialite_tool -i -shp "./combined-shapefile-with-oceans" -d "${tz_file}" -t tz_world -s 4326 -g geom -c UTF-8 1>&2 || error_exit "spatialite_tool import failed"
spatialite ${tz_file} "SELECT CreateSpatialIndex('tz_world', 'geom');" 1>&2 || error_exit "SpatialIndex failed"
spatialite ${tz_file} "VACUUM;" 1>&2 || error_exit "VACUUM failed"
spatialite ${tz_file} "ANALYZE;" 1>&2 || error_exit "ANALYZE failed"

rm -rf /data/combined-shapefile-with-oceans* /data/alias_tz.csv

cat ${tz_file}
