#!/bin/sh

set -e  # Exit immediately if a command exits with a non-zero status

if [ ! -f ./timezones-with-oceans.shapefile.zip ]; then
  echo 'Timezone polygon file "timezones-with-oceans.shapefile.zip" is not found'

  exit 1
else
  echo 'Unzip timezone polygon file "timezones-with-oceans.shapefile.zip"...'

  unzip ./timezones-with-oceans.shapefile.zip || exit 1
fi

echo "Create spatial database..."

tz_file=$(mktemp)
spatialite_tool -i -shp ./combined-shapefile-with-oceans -d ${tz_file} -t tz_world -s 4326 -g geom -c UTF-8 || exit 1
spatialite ${tz_file} "SELECT CreateSpatialIndex('tz_world', 'geom');" || exit 1
spatialite ${tz_file} "VACUUM;" || exit 1
spatialite ${tz_file} "ANALYZE;" || exit 1

rm -rf /data/combined-shapefile-with-oceans* /data/alias_tz.csv

cat ${tz_file}
