<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valhalla Vector Tiles Demo</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .tile-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="tile-info" id="tile-info">
        Zoom: <span id="zoom">10</span> | 
        Center: <span id="center">[24.75, 59.44]</span>
    </div>

    <script>
        // Configuration
        const TILE_SERVER_URL = 'http://localhost:8080';
        const MAPBOX_TOKEN = 'YOUR_MAPBOX_TOKEN_HERE'; // Replace with your token
        
        // Set Mapbox access token
        mapboxgl.accessToken = MAPBOX_TOKEN;
        
        // Initialize the map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12', // Use Mapbox streets style
            center: [24.7536, 59.4372], // Default to Tallinn
            zoom: 10
        });
        
        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-left');
        map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');
        
        // Add Valhalla tile source and layers when map loads
        map.on('load', () => {
                map.addSource('valhalla', {
                    type: 'vector',
                    tiles: [`${TILE_SERVER_URL}/{z}/{x}/{y}.mvt`],
                    minzoom: 0,
                    maxzoom: 18,  
                    scheme: 'xyz'
                });
                
                // Render roads layer (zoom >= 12)
                // Tiles are generated up to z18, beyond that Mapbox will overzoom (scale up) z18 tiles
                // Color roads by hierarchy level:
                //   Level 0: Red (highways/motorways)
                //   Level 1: Orange (major roads)
                //   Level 2: Yellow (local streets)
                map.addLayer({
                    id: 'valhalla-roads',
                    type: 'line',
                    source: 'valhalla',
                    'source-layer': 'roads',
                    minzoom: 12,  // Match the C++ code threshold
                    maxzoom: 22,  // Allow rendering even at max zoom (with overzoomed tiles)
                    paint: {
                        'line-color': [
                            'match',
                            ['get', 'level'],
                            0, '#ff0000',  // Level 0: Red (highways)
                            1, '#ff8800',  // Level 1: Orange (major roads)
                            2, '#ffdd00',  // Level 2: Yellow (local streets)
                            '#ff00ff'      // Default: Magenta (shouldn't happen)
                        ],
                        'line-width': [
                            'interpolate',
                            ['exponential', 1.5],
                            ['zoom'],
                            12, ['match', ['get', 'level'], 0, 3, 1, 2, 2, 1, 2],  // Level 0=3px, 1=2px, 2=1px
                            14, ['match', ['get', 'level'], 0, 4, 1, 3, 2, 2, 3],  // Wider at z14
                            16, ['match', ['get', 'level'], 0, 6, 1, 4, 2, 3, 4],  // Wider at z16
                            18, ['match', ['get', 'level'], 0, 8, 1, 6, 2, 4, 6],  // Wider at z18
                            20, ['match', ['get', 'level'], 0, 10, 1, 8, 2, 6, 8], // Wider at z20
                            22, ['match', ['get', 'level'], 0, 12, 1, 10, 2, 8, 10] // Wider at z22
                        ],
                        'line-opacity': 0.8
                    }
                }); 
                
                map.addLayer({
                    id: 'valhalla-nodes',
                    type: 'circle',
                    source: 'valhalla',
                    'source-layer': 'nodes',
                    minzoom: 16,
                    maxzoom: 22,
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            16, 2,
                            18, 4,
                            20, 6
                        ],
                        'circle-color': [
                            'case',
                            ['get', 'traffic_signal'], '#ff0000',  // Red for traffic signals
                            '#0088ff'  // Blue for other nodes
                        ],
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 1,
                        'circle-opacity': 0.8
                    }
                });
                
                // Render points layer (zoom < 12)
                map.addLayer({
                    id: 'valhalla-points',
                    type: 'circle',
                    source: 'valhalla',
                    'source-layer': 'points',
                    maxzoom: 12,
                    paint: {
                        'circle-radius': 20,
                        'circle-color': '#ff0000',
                        'circle-stroke-color': '#ffff00',
                        'circle-stroke-width': 3
                    }
                });
                
                // Add labels showing tile coordinates
                map.addLayer({
                    id: 'valhalla-labels',
                    type: 'symbol',
                    source: 'valhalla',
                    'source-layer': 'points',  // Changed from 'bbox' to 'points'
                    layout: {
                        'text-field': ['concat', 
                            'z: ', ['get', 'z'], '\n',
                            'x: ', ['get', 'x'], '\n',
                            'y: ', ['get', 'y']
                        ],
                        'text-font': ['Noto Sans Regular'],
                        'text-size': 12
                    },
                    paint: {
                        'text-color': '#ff0000',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 2
                    }
                });
                
                // Add click handler to show feature properties
                map.on('click', 'valhalla-roads', (e) => {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        const props = feature.properties;
                        
                        // Map road class numbers to names
                        const roadClassNames = {
                            0: 'Motorway', 1: 'Trunk', 2: 'Primary', 3: 'Secondary',
                            4: 'Tertiary', 5: 'Unclassified', 6: 'Residential', 7: 'Service/Other'
                        };
                        
                        // Map use numbers to names
                        const useNames = {
                            0: 'Road', 1: 'Ramp', 2: 'Turn Channel', 3: 'Track',
                            4: 'Driveway', 5: 'Alley', 6: 'Parking Aisle', 7: 'Emergency Access',
                            8: 'Drive-Through', 9: 'Culdesac', 10: 'Cycleway', 11: 'Mountain Bike',
                            12: 'Sidewalk', 13: 'Footway', 14: 'Steps', 15: 'Path',
                            16: 'Pedestrian', 17: 'Bridleway', 18: 'Other', 19: 'Ferry',
                            20: 'Rail-Ferry', 21: 'Construction', 22: 'Transit Connection'
                        };
                        
                        let html = '<div style="font-family: monospace; font-size: 12px;">';
                        html += `<strong>Valhalla Road</strong><br/>`;
                        html += `<strong>Feature ID:</strong> ${feature.id}<br/>`;
                        html += `<strong>Level:</strong> ${props.level}<br/><br/>`;
                        
                        // Show forward direction if exists
                        if (props['edge_id:forward']) {
                            html += `<strong style="color: #00aa00;">➡️ Forward Direction</strong><br/>`;
                            html += `  <strong>Edge ID:</strong> ${props['edge_id:forward']}<br/>`;
                            html += `  <strong>Road Class:</strong> ${roadClassNames[props['road_class:forward']] || props['road_class:forward']}<br/>`;
                            html += `  <strong>Use:</strong> ${useNames[props['use:forward']] || props['use:forward']}<br/>`;
                            html += `  <strong>Tunnel:</strong> ${props['tunnel:forward'] ? '✅' : '❌'} `;
                            html += `<strong>Bridge:</strong> ${props['bridge:forward'] ? '✅' : '❌'} `;
                            html += `<strong>Roundabout:</strong> ${props['roundabout:forward'] ? '✅' : '❌'}<br/>`;
                        }
                        
                        // Show reverse direction if exists
                        if (props['edge_id:reverse']) {
                            html += `<br/><strong style="color: #aa0000;">⬅️ Reverse Direction</strong><br/>`;
                            html += `  <strong>Edge ID:</strong> ${props['edge_id:reverse']}<br/>`;
                            html += `  <strong>Road Class:</strong> ${roadClassNames[props['road_class:reverse']] || props['road_class:reverse']}<br/>`;
                            html += `  <strong>Use:</strong> ${useNames[props['use:reverse']] || props['use:reverse']}<br/>`;
                            html += `  <strong>Tunnel:</strong> ${props['tunnel:reverse'] ? '✅' : '❌'} `;
                            html += `<strong>Bridge:</strong> ${props['bridge:reverse'] ? '✅' : '❌'} `;
                            html += `<strong>Roundabout:</strong> ${props['roundabout:reverse'] ? '✅' : '❌'}<br/>`;
                        }
                        
                        html += '</div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(html)
                            .addTo(map);
                    }
                });
                
                // Add click handler for nodes
                map.on('click', 'valhalla-nodes', (e) => {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        const props = feature.properties;
                        
                        // Map node type numbers to names
                        const nodeTypeNames = {
                            0: 'Street Intersection', 1: 'Gate', 2: 'Bollard',
                            3: 'Toll Booth', 4: 'Multi-Use Transit Stop', 5: 'Bike Share',
                            6: 'Parking', 7: 'Motor Way Junction', 8: 'Border Control',
                            9: 'Toll Gantry', 10: 'Sump Buster', 11: 'Building Entrance',
                            12: 'Elevator'
                        };
                        
                        let html = '<div style="font-family: monospace; font-size: 12px;">';
                        html += `<strong>Node</strong><br/>`;
                        html += `<strong>Node ID:</strong> ${props.node_id || feature.id}<br/>`;
                        html += `<strong>Type:</strong> ${nodeTypeNames[props.type] || props.type}<br/>`;
                        html += `<strong>Traffic Signal:</strong> ${props.traffic_signal ? '🚦 Yes' : '❌ No'}<br/>`;
                        html += `<strong>Access:</strong> ${props.access}<br/>`;
                        html += '</div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(html)
                            .addTo(map);
                    }
                });
                
                // Change cursor on hover
                map.on('mouseenter', 'valhalla-roads', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                
                map.on('mouseleave', 'valhalla-roads', () => {
                    map.getCanvas().style.cursor = '';
                });
                
                map.on('mouseenter', 'valhalla-nodes', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                
                map.on('mouseleave', 'valhalla-nodes', () => {
                    map.getCanvas().style.cursor = '';
                });
        });
        
        // Update tile info display
        function updateTileInfo() {
            const zoom = map.getZoom().toFixed(2);
            const center = map.getCenter();
            document.getElementById('zoom').textContent = zoom;
            document.getElementById('center').textContent = 
                `[${center.lng.toFixed(4)}, ${center.lat.toFixed(4)}]`;
        }
        
        map.on('move', updateTileInfo);
        map.on('zoom', updateTileInfo);
    </script>
</body>
</html>

